# 경계 간 매핑하기

> 매핑 전략에 찬성하는 의견

    두 계층 간에 매핑을 하지 않으면 양 계층에서 같은 모델을 사용해야 하는데 이렇게 하면 두 계층이 강하게 결합된다.

> 매핑 전략에 반대하는 의견

    두 계층 간에 매핑을 하게 되면 코드 중복이 너무 많이 일어난다.
    많은 유스케이스들이 오직 CRUD만 수행하고 계층에 걸쳐 같은 모델을 사용하기 때문에 계층 사이의 매핑은 과하다.

두 의견 모두 일정 부분 맞다. 몇가지 매핑 전략을 장단점과 함께 살펴보며 언제 어떤 전략을 사용하면 좋을지 생각해보자. <br><br>


## 1) 매핑하지 않기 전략

<img width="741" alt="1" src="https://user-images.githubusercontent.com/48689213/210478109-c8fcbcab-5761-4cf8-94ad-47caed43083c.png">

지금부터 살펴볼 그림들은 앞에서 보았던 '송금하기' 유즈케이스 구조를 도식화 한 것이다.

이 그림 에서는 웹 계층(컨트롤러)과 어플리케이션 계층(서비스), 영속성 계층(레포지토리)이 모두 ```Account``` 도메인 모델을 전용 모델로 사용하고 있다.

즉 계층간 매핑이 전혀 이루어지지 않았으며, 세 계층이 하나의 ```Account``` 도메인 모델을 공유하여 사용하고 있고, 이런 형태를 '매핑하지 않기 전략' 이라 부른다. <br><br>


> 매핑하지 않기 전략의 장점

모든 계층이 정확히 같은 구조의 같은 정보를 필요로 한다면 매핑하지 않기 전략은 완벽한 선택지이다.

예를 들어 간단한 CRUD 유즈케이스의 경우, 컨트롤러 계층의 모델과 레포지토리 계층의 모델의 코드가 완전히 동일하면 계층마다 별도의 모델을 둘 필요가 없다. <br><br>


> 매핑하지 않기 전략의 단점

컨트롤러 계층의 필요로 ```Account``` 모델에 어노테이션을 추가하거나, 어플리케이션 계층의 필요로 ```Account``` 모델에 특정 커스텀 필드를 둬야하는 등

모든 계층이 같은 구조의 같은 정보를 필요로 하지 않을 수 있다.

이 때 매핑하지 않기 전략을 사용하면 단일 책임 원칙(클래스를 변경하는 이유는 오로지 하나여야 한다)을 위배하게 된다.

```Account``` 모델 클래스를 변경하는 이유가 컨트롤러, 서비스, 레포지토리 계층 총 세가지나 되기 때문이다. <br><br>


## 2) 양방향 매핑 전략

<img width="742" alt="2" src="https://user-images.githubusercontent.com/48689213/210478120-266582b9-e7db-44a2-981b-85bc07c1cc24.png">

각 계층이 전용 모델을 가지는 매핑 전략을 '양방향 매핑 전략' 이라고 한다.

위 그림처럼 양방향 매핑 전략에서는 각 계층이 도메인 모델과 완전히 다른 구조의 전용 모델을 갖는다.

<img width="742" alt="2" src="https://user-images.githubusercontent.com/48689213/211154371-29229ddc-c8d7-48c2-a9eb-34c387a10bf7.png">

각 계층에서는 입력 받은 전용 모델을 도메인 모델로 매핑되기도 하고, 도메인 모델이 다시 전용 모델로 매핑되기도 하기 때문에 양방향 매핑이라고 부른다. 

많은 개발자들이 이 매핑 전략을 반드시 지켜야 하는 철칙처럼 생각하는데, 이는 개발을 쓸데없이 더디게 만들기도 한다.

어떠한 매핑 전략도 철칙처럼 여겨져서는 안되며, 각 유즈케이스마다 적절한 전략을 택할 수 있어야 한다. <br><br>


> 양방향 매핑 전략의 장점

각 계층이 전용 모델을 가지고 있기 때문에 각 계층에서 모델을 변경하더라도 다른 계층에 영향이 없다.

즉 단일 책임 원칙을 만족하는 구조가 된다.

또한 개념적으로는 '매핑하지 않기' 전략 다음으로 간단하다. 매핑 책임이 명확하기 때문이다.

바깥쪽 계층/어댑터에서 해당 계층 모델을 안쪽 계층 모델로 매핑하고, 다시 안쪽 계층 모델을 해당 계층 모델로 매핑하기 때문에

안쪽 계층은 안쪽 계층의 모델만 알면 되어 매핑 대신 해당 계층의 로직에 집중할 수 있다. <br><br>


> 양방향 매핑 전략의 단점

먼저 코드의 중복이 많이 생길 수 있다.

코드의 양을 줄이기 위해 매핑 프레임워크를 사용하면 두 모델 간 매핑을 구현하는데 꽤 시간이 들 수 있다.

특히 매핑 프레임워크가 내부 동작 방식을 제네릭 코드와 리플렉션 뒤로 숨기는 경우 매핑 로직을 디버깅하는 것은 꽤나 힘들 수 있다.

그리고 이 매핑 전략에서는 도메인 모델이 함수의 파라미터와 반환값으로 사용되는데, 이 경우 도메인 모델이 바깥쪽 계층의 변화에 취약해질 수 있다. <br><br>


## 3) 완전 매핑 전략

<img width="742" alt="3" src="https://user-images.githubusercontent.com/48689213/210478131-79ce89ef-d759-4d96-b10e-b8fac246c265.png">

이 매핑 전략에서는 각 연산마다 별도의 입출력 모델을 사용한다.

계층 간 통신에서 도메인 모델을 사용하는 대신 그림의 ```SendMoneyCommand```(```SendMoneyUseCase```의 입력 모델로 사용된다) 처럼

각 작업에 특화된 모델을 사용한다.

이런 모델을 command 혹은 request 라 표현하기도 하며, 각 모델은 관련된 유즈케이스에 특화된 전용 필드와 로직을 가진다. <br><br>


이 전략은 컨트롤러 계층과 서비스 계층 사이에서 사용하는게 가장 좋고,

서비스 계층과 레포지토리 계층 사이에서는 매핑 오버헤드 떄문에 사용하지 않는 것이 좋다.

어떤 경우에는 입력 모델에서만 이 매핑 전략을 사용하고, 도메인 객체를 그대로 출력 모델로 사용해도 된다. <br><br>


이처럼 매핑 전략은 여러가지를 섞어 쓸 수 있고, 섞어 쓸 때 더 좋은 효과가 나타나는 경우가 많다.

어떠한 매핑 전략도 모든 계층에 동일하게 적용되어야 하는 규칙일 필요는 없다. <br><br>


> 완전 매핑 전략의 장점

여러 유즈케이스의 요구사항을 하나의 전용 모델에서 다루는 것 보다 구현하고 유지보수하기 훨씬 쉽다. <br><br>


> 완전 매핑 전략의 단점

한 계층의 전용 모델을 다른 여러개의 커맨드로 매핑하기 위해 더 많은 코드와 매핑 작업이 필요하다. <br><br>


## 4) 단방향 매핑 전략

<img width="742" alt="4" src="https://user-images.githubusercontent.com/48689213/210478140-c5b715a5-b961-43cf-b945-95c13fa1800a.png">

이 전략에서는 모든 계층이 전용 모델을 가지되, 각 모델들이 동일한 인터페이스를 구현한다.

이 인터페이스는 도메인 모델에서 필요한 필드에 대한 getter 메서드를 제공하여 도메인 모델의 상태를 캡슐화한다. <br><br>


인터페이스를 통해 도메인 모델은 풍부한 행동을 구현할 수 있고, 다른 계층에서 이 행동에 접근할 수 있다.

또한 도메인 모델의 정보를 매핑 없이 다른 계층으로 전달할 수 있다. <br><br>


이 전략에서 바깥 계층은 인터페이스를 이용할지, 전용 모델을 도메인 모델로 매핑할지 결정할 수 있다.

단 도메인 모델로 매핑하는 것은 factory 라는 DDD 개념과 잘 어울린다. <br><br>


이 전략은 계층간 모델이 동일하지는 않지만, 비슷할 때 가장 효과적이다. <br><br>


> 단방향 매핑 전략의 장점

이 전략에서 매핑 책임은 아주 명확하다.

한 계층이 다른 계층으로부터 객체를 받으면 해당 계층에서 이용할 수 있는 모델로 매핑하면 된다.

따라서 각 계층은 한 방향으로만 매핑을 수행하게 된다. <br><br>


> 단방향 매핑 전략의 단점

매핑 개념이 모델에서 모델 뿐만 아니라 인터페이스까지 퍼져 있기 때문에 이 전략은 다른 전략에 비해 개념적으로 어렵다. <br><br>


## 매핑 전략 선택 방법

언제 어떤 매핑 전략을 사용하는게 좋은지는 '그때 그때 다르다'.

즉 하나의 전략을 전체 코드에 대한 전역 규칙으로 정의해서는 안된다. <br><br>


소프트웨어는 시간이 지나며 변화를 거듭하기 때문에, 고정된 매핑 전략으로 계속 유지하기 보다는

빠르게 코드를 짤 수 있는 간단한 전략으로 시작해서 계층 간 결합을 떼어내는 데 도움이 되는 복잡한 전략으로 갈아타는 것도 괜찮은 방법이다. <br><br>


## 정리

어떤 매핑 전략을 선택했더라도 나중에 언제든 바꿀 수 있다.

따라서 처음에는 단순한 매핑 전략을 사용하다가, 시간이 지남에 따라 유즈케이스가 고도화되면서

조금 더 높은 수준의 매핑 전략을 사용하는 것도 좋은 방법이다.

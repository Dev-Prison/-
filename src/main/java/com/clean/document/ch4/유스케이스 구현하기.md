# 4. 유즈케이스 구현하기
이번 장에서는 육각형 아키텍처 스타일에서 유즈케이스를 구현하는 방법을 알아본다.

이를 위해 한 계좌에서 다른 계좌로 돈을 송금하는 유즈케이스를 구현해 볼 것이다.

먼저 도메인 엔티티를 만드는 방법을 살펴본 다음, 해당 도메인 엔티티를 중심으로 유즈케이스를 구현해보자.

이 때 도메인은 대상, 유즈케이스는 대상에 가해지는 행위 정도로 생각하면 이해하기 쉽다.
<br>
<br>

## 1) 도메인 구현하기
먼저 입출금이 가능한 Account 엔티티를 만들자.

``` java
public class Account {
    private AccountId id;
    private Money baselineBalance;
    private ActivityWindow activityWindow;

    public Money calculateBalance() {
        return Money.add(
                this.baselineBalance,
                this.activityWindow.calculateBalance(this.id)
        );
    }

    public boolean withdraw(Money money, AccountId targetAccountId) {
        if(!mayWithdraw(money)) {
            return false;
        }

        Activity withdrawal = new Activity(
                this.id,
                this.id,
                targetAccountId,
                LocalDateTime.now(),
                money
        );

        this.activityWindow.addActivity(withdrawal);
        return true;
    }

    private boolean mayWithdraw(Money money) {
        return Money.add(
                this.calculateBalance(),
                money.negate()
        ).isPositive();
    }

    public boolean deposit(Money money, AccountId sourceAccountId) {
        Activity deposit = new Activity(
                this.id,
                sourceAccountId,
                this.id,
                LocalDateTime.now(),
                money
        );

        this.activityWindow.addActivity(deposit);
        return true;
    }

    @Value
    public static class AccountId {
        private Long value;
    }
}
```
`Account 엔티티`에 대한 모든 입금과 출금은 `Activity 엔티티`를 사용하고 있는데,

`Account 엔티티`가 도메인 이라면 `Activity 엔티티`는 유즈케이스 라고 할 수 있다.

`ActivityWindow` 란 무엇인가? 한 계좌에 요청된 모든 행위를 메모리에 한꺼번에 올려두는 것은 성능 저하의 원인이 될 수 있기 때문에,

`Account 엔티티`는 `ActivityWindow 객체`를 둠으로써 특정 기간동안의 행위만을 보유하고 있을 수 있다.

그리고 외부에서 Account 엔티티에 요청이 들어오면 withdraw(삭제), deposit(추가) 메소드를 이용해

`ActivityWindow` 에 새로운 행위를 더하거나 과거의 행위를 제거할 수 있다.

Account 엔티티는 도메인 모델이기 때문에 행위를 구현하지 않았다.

단지 관련 속성(계좌번호, 잔액 등)만 포함하고, 행위는 모두 Activity 엔티티로 구현해 해당 엔티티를 가져다가 사용하기만 한다.
<br>
<br>

### ✅ 풍부한 도메인 모델 vs 빈약한 도메인 모델
내용을 입력하세요.
<br>
<br>

## 2) 유즈케이스 구현하기
```
1. 입력을 받는다.
2. 비즈니스 규칙을 검증한다. (이는 도메인 엔티티와 공유하는 책임이다)
3. 모델 상태를 조작한다. (조작 후 영속성 계층에 전달해 저장한다)
4. 출력을 반환한다. (조작 및 저장 결과 반환한다)
```
위는 유즈케이스의 역할이다. 이를 바탕으로 송금 유즈케이스를 구현해보자.

넓은 서비스 문제를 피하기 위해 모든 유즈케이스를 한 서비스 클래스에 넣지 말고, 각 유즈케이스별를 각각의 분리된 서비스 클래스로 만들자.

``` java
@RequiredArgsConstructor
@Transactional
public class SendMoneyService implements SendMoneyUseCase {

    private final LoadAccountPort loadAccountPort;
    private final AccountLock accountLock;
    private final UpdateAccountStatePort updateAccountStatePort;
    
    @Override
    public boolean sendMoney(SendMoneyCommand command) {
        //TODO: 비즈니스 규칙 검증
        //TODO: 모델 상태 조작
        //TODO: 출력 값 반환
    }
}
```
서비스는 SendMoneyUseCase를 구현하고, 계좌 정보를 불러오기 위해 Load AccouintPort를 호출한다.

그리고 변경된 계좌 상태를 저장하기 위해 UpdateAccountStatePort를 호출한다.

@이미지
<br>
<br>

### ✅ 입력 유효성 검증
입력 유효성 검증은 유즈케이스의 책임이 아니다. 이는 입력 모델에서 다루는 것이 바람직하다.

현 유즈케이스에서 입력 모델은 SendMoneyCommand 이다.

이 입력 모델의 생성자에서 입력 유효성을 검증하는 로직을 작성할 수도 있지만,

자바의 Bean Validation API 표준 라이브러리를 사용하면 훨씬 간편하게 해당 작업을 처리할 수 있다.

``` java
@Getter
public class SendMoneyCommand extends SelfValidating<SendMoneyCommand> {

    @NotNull
    private final AccountId sourceAccountId;

    @NotNull
    private final AccountId targetAccountId;

    @NotNull
    private final Money money;

    public SendMoneyCommand(
            AccountId sourceAccountId,
            AccountId targetAccountId,
            Money money) {
        this.sourceAccountId = sourceAccountId;
        this.targetAccountId = targetAccountId;
        this.money = money;
        requireGreaterThan(money, 0)
        this.validateSelf();
    }
}
```
기본적으로 제공되는 유효성 검증 도구가 부족하다면 직접 구현하는 것도 가능하다.
``` java

```

<br>
<br>

### ✅ 생성자 활용하기
내용을 입력하세요.
<br>
<br>

### ✅ 유즈케이스의 입력 모델
내용을 입력하세요.
<br>
<br>

### ✅ 비즈니스 규칙 검증
내용을 입력하세요.
<br>
<br>

### ✅ 유즈케이스의 출력 모델
내용을 입력하세요.
<br>
<br>

### ✅ 읽기 전용 유즈케이스
내용을 입력하세요.
<br>
<br>

## 3) 정리
내용을 입력하세요.
<br>
<br>
